@page "/authors/delete/{Id}"
@attribute [Authorize(Roles = "Administrator")]
@inject IAuthorRepository repo
@inject NavigationManager NavManager

<h3 class="card-title">Are you sure you want to delete this record?</h3>
<hr/>
<br/>

@if (isFailed)
{
	<ErrorMessage Message="Something went wrong with the operation" />
}

@if (Model == null)
{
	<LoadingMessage Message="Loading Author for edit" />
}
else
{
	<div class="col-md-4">
		<table class=" table table-responsive">
			<tr>
				<td>First Name</td>
				<td>@Model.Firstname</td>
			</tr>
			<tr>
				<td>Last Name</td>
				<td>@Model.Lastname</td>
			</tr>
			<tr>
				<td>Biography</td>
				<td>@Model.Bio</td>
			</tr>
		</table>
		<br />
		@if (Model.Books == null || !Model.Books.Any())
		{
			<div class="alert alert-dismissible alert-secondary">
				No books for this author
			</div>
		}
		else
		{
			<div class="card" style="width: 18rem;">
				<div class="card-header">
					Author's Books
				</div>
				<ul class="list-group list-group-flush">
					@foreach (var book in Model.Books)
					{
						<li class="list-group-item">@book.Title - @book.Price</li>
					}
				</ul>
			</div>
		}
	</div>
	<br />

	<button @onclick="DeleteAuthor" class="btn btn-danger" type="submit">
		<span class="oi oi-delete"></span>
		Delete Author
	</button>
	<button @onclick="BackToList" class="btn btn-outline-secondary">
		<span class="oi oi-media-skip-backward"></span>
		Back to list
	</button>
}

@code {

	[Parameter]
	public string Id { get; set; }

	private Author Model;

	private bool isFailed;

	protected override async Task OnAfterRenderAsync(bool firstRender)
	{
		if (firstRender)
		{
			var id = Convert.ToInt32(Id);
			Model = await repo.Get(Endpoints.AuthorsEndpoint, id);

			StateHasChanged();
		}
	}

	private async Task DeleteAuthor()
	{
		var isSuccess = await repo.Delete(Endpoints.AuthorsEndpoint, Model.Id);
		if (isSuccess)
		{
			BackToList();
		}
		else
		{
			isFailed = true;
		}
	}

	private void BackToList() => NavManager.NavigateTo("/authors/");
}